{% extends "layout.html" %}

{% block content %}

<!-- AG Grid Community (CDN) - v33+ Theming API (no legacy CSS themes) -->
<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

<!-- Google Font: Noto Sans -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto%20Sans:wght@400;700&display=swap" rel="stylesheet">

<script>

var parseTime = d3.timeParse("%Y-%m-%d %H:%M:%S"), formatShortDate = d3.timeFormat("%Y-%m-%d %H:%M"),formatDate = d3.timeFormat("%Y-%m-%d");

$(document).ready( function () {
  {
    var objSelect = document.getElementById("myform").period;
    var select = "{{ period or '' }}";
    setSelectedValue(objSelect, select);
  }
  {
    var objSelect = document.getElementById("myform").value_lt;
    var select = "{{ value_lt or '' }}";
    setSelectedValue(objSelect, select);
  }
  {
    var objSelect = document.getElementById("myform").value_gt;
    var select = "{{ value_gt or '' }}";
    setSelectedValue(objSelect, select);
  }
  {
    var objSelect = document.getElementById("myform").t_type;
    var select = "{{ t_type or '' }}";
    setSelectedValue(objSelect, select);
  }

  // Apply configured table font size to AG Grid containers (avoid Jinja in CSS).
  $('.ag-grid-host').css('font-size', "{{ theme.TABLE_FONT_SIZE }}");

  initTransactionsGrid();

  // Fit grid height to available viewport space.
  autoSizeTransactionGridHeight();
  var _resizeTimer = null;
  window.addEventListener('resize', function() {
    if (_resizeTimer) window.clearTimeout(_resizeTimer);
    _resizeTimer = window.setTimeout(function() {
      autoSizeTransactionGridHeight();
    }, 100);
  });

  var searchEl = document.getElementById('descriptionSearchInput');
  if (searchEl) {
    searchEl.addEventListener('input', function() {
      setDescriptionSearch(searchEl.value);
    });
  }
});

var txnGridApi = null;

function autoSizeTransactionGridHeight() {
  var gridEl = document.getElementById('transaction_grid');
  if (!gridEl) return;

  // Compute available space from the grid's current top position.
  var rect = gridEl.getBoundingClientRect();
  var viewportH = window.innerHeight || document.documentElement.clientHeight || 800;
  var bottomPad = 20;
  var available = viewportH - rect.top - bottomPad;
  var h = Math.max(260, Math.floor(available));
  gridEl.style.height = h + 'px';

  // Tell the grid to re-layout after container resize.
  if (txnGridApi && typeof txnGridApi.doLayout === 'function') {
    txnGridApi.doLayout();
  }
}

function fmtAmount(v) {
  var num = (typeof v === 'number') ? v : parseFloat(v);
  if (isNaN(num)) num = 0;
  return num.toLocaleString('en-US', { maximumFractionDigits: 0 });
}

function sanitizeTsvCell(v) {
  if (v == null) return '';
  return String(v).replace(/\t/g, ' ').replace(/\r?\n/g, ' ').trim();
}

async function copyTextToClipboard(text) {
  if (!text) return false;
  if (navigator.clipboard && window.isSecureContext) {
    await navigator.clipboard.writeText(text);
    return true;
  }
  var ta = document.createElement('textarea');
  ta.value = text;
  ta.setAttribute('readonly', '');
  ta.style.position = 'absolute';
  ta.style.left = '-9999px';
  document.body.appendChild(ta);
  ta.select();
  ta.setSelectionRange(0, ta.value.length);
  var ok = false;
  try {
    ok = document.execCommand('copy');
  } catch (e) {
    ok = false;
  }
  document.body.removeChild(ta);
  return ok;
}

function buildTransactionsTsv() {
  if (!txnGridApi) return '';
  var header = ['ID', 'Date', 'Description', 'Amount', 'Class', 'Group', 'Source', 'Type'];
  var lines = [header.join('\t')];

  var iter = (typeof txnGridApi.forEachNodeAfterFilterAndSort === 'function')
    ? txnGridApi.forEachNodeAfterFilterAndSort.bind(txnGridApi)
    : (typeof txnGridApi.forEachNode === 'function' ? txnGridApi.forEachNode.bind(txnGridApi) : null);

  if (!iter) return lines.join('\n');

  iter(function(node) {
    if (!node || !node.data) return;
    var d = node.data;
    lines.push([
      sanitizeTsvCell(d.id),
      sanitizeTsvCell(d.date),
      sanitizeTsvCell(d.description),
      sanitizeTsvCell(fmtAmount(d.amount)),
      sanitizeTsvCell(d.className),
      sanitizeTsvCell(d.groupName),
      sanitizeTsvCell(d.source),
      sanitizeTsvCell(d.type)
    ].join('\t'));
  });

  return lines.join('\n');
}

async function copyTransactionsToClipboard() {
  var btn = document.getElementById('transactionCopyBtn');
  try {
    var tsv = buildTransactionsTsv();
    if (!tsv || tsv.split('\n').length <= 1) {
      if (btn) btn.innerText = 'No rows';
      return;
    }
    if (btn) {
      btn.disabled = true;
      btn.innerText = 'Copying...';
    }
    var ok = await copyTextToClipboard(tsv);
    if (btn) {
      btn.innerText = ok ? 'Copied' : 'Copy failed';
      setTimeout(function() {
        btn.innerText = 'Copy';
        btn.disabled = false;
      }, 1200);
    }
  } catch (e) {
    if (btn) {
      btn.innerText = 'Copy failed';
      btn.disabled = false;
    }
  }
}

function setGridRows(api, rows) {
  if (!api) return;
  if (typeof api.setRowData === 'function') {
    api.setRowData(rows || []);
    return;
  }
  if (typeof api.setGridOption === 'function') {
    api.setGridOption('rowData', rows || []);
    return;
  }
}

function setDescriptionSearch(text) {
  if (!txnGridApi) return;
  var q = (text || '').toString();

  // Preserve existing filters while updating just the description filter.
  var model = {};
  if (typeof txnGridApi.getFilterModel === 'function') {
    model = txnGridApi.getFilterModel() || {};
  } else if (typeof txnGridApi.getGridOption === 'function') {
    model = txnGridApi.getGridOption('filterModel') || {};
  }

  if (!q.trim()) {
    if (model && model.description) {
      delete model.description;
    }
  } else {
    model = model || {};
    model.description = {
      filterType: 'text',
      type: 'contains',
      filter: q
    };
  }

  if (typeof txnGridApi.setFilterModel === 'function') {
    txnGridApi.setFilterModel(model);
    if (typeof txnGridApi.onFilterChanged === 'function') {
      txnGridApi.onFilterChanged();
    }
    return;
  }

  if (typeof txnGridApi.setGridOption === 'function') {
    txnGridApi.setGridOption('filterModel', model);
    return;
  }
}

function initTransactionsGrid() {
  if (typeof agGrid === 'undefined' || (typeof agGrid.createGrid !== 'function' && typeof agGrid.Grid !== 'function')) {
    return;
  }

  var gridTheme = agGrid.themeQuartz.withPart(agGrid.colorSchemeDark);

  var defaultColDef = {
    sortable: true,
    resizable: true,
    filter: true
  };

  var options = {
    theme: gridTheme,
    defaultColDef: defaultColDef,
    rowSelection: 'single',
    suppressCellFocus: true,
    rowData: [],
    columnDefs: [
      { headerName: 'ID', field: 'id', width: 90 },
      { headerName: 'Date', field: 'date', width: 120, sort: 'desc' },
      { headerName: 'Description', field: 'description', flex: 1, minWidth: 200 },
      { headerName: 'Amount', field: 'amount', width: 120, valueFormatter: function(p){ return fmtAmount(p.value); } },
      { headerName: 'Class', field: 'className', width: 140 },
      { headerName: 'Group', field: 'groupName', width: 140 },
      { headerName: 'Source', field: 'source', width: 140 },
      { headerName: 'Type', field: 'type', width: 140 }
    ]
  };

  var el = document.getElementById('transaction_grid');
  if (!el) return;

  if (typeof agGrid.Grid === 'function') {
    new agGrid.Grid(el, options);
    txnGridApi = options.api || null;
  } else {
    txnGridApi = agGrid.createGrid(el, options, { setThemeOnGridDiv: true });
  }

  // server-rendered rows -> grid rows
  var raw = [];
  var jsonEl = document.getElementById('initialTransactionsJson');
  if (jsonEl) {
    try {
      raw = JSON.parse(jsonEl.textContent || jsonEl.innerText || '[]');
    } catch (e) {
      raw = [];
    }
  }
  var rows = (raw || []).map(function(r) {
    return {
      id: r[0],
      date: r[1],
      description: r[2],
      amount: +r[3],
      className: r[4],
      groupName: r[5],
      source: r[6],
      type: r[7]
    };
  });
  setGridRows(txnGridApi, rows);
}

</script>

<style type="text/css">

.noBorder {
    border: 0px;
    padding:0; 
    margin:0;
    border-collapse: collapse;
}

/* Match Transaction Summary styling */
.ag-grid-host {
  font-family: 'Noto Sans', sans-serif;
}

/* AG Grid selection = yellow text only */
.ag-grid-host .ag-row-selected,
.ag-grid-host .ag-row-selected .ag-cell {
  background-color: inherit !important;
}

.ag-grid-host .ag-row-selected .ag-cell {
  color: #ffff00 !important;
}

/* AG Grid hover highlight = dark */
.ag-grid-host .ag-row-hover:not(.ag-row-selected) .ag-cell {
  background-color: rgba(0, 0, 0, 0.35) !important;
}

.ag-grid-host .ag-root-wrapper,
.ag-grid-host .ag-root-wrapper * {
  font-family: 'Noto Sans', sans-serif !important;
  font-size: inherit !important;
}

.card .card-header {
  font-family: 'Noto Sans', sans-serif !important;
}
/* .transactions_table.dataTable tbody td {
  vertical-align: middle;
} */
/* .table.dataTable td {
  font-size: 1em;
} */
/* .table.dataTable {
    font-family: tahoma;
    font-size: 13px;
    direction: rtl;
    position: relative;
    clear: both;
    *zoom: 1;
    zoom: 1;
} */

</style>

<!-- <centre><h2>Transactions</h2></centre> -->

<!-- <div class="col-12">
  <div class="card bg-dark mb-3">
    <div class="card-body"> -->
      <form method="get" _lpchecked="1" id="myform">
        <fieldset>
      <div class="form-group row">
        <!-- <div class="col-3" style="width:100px;">
              <label for="duration" class="form-label">Period</label>
          </div> -->
          <div class="col-3" style="width:170px">
            <div class="form-outline">
              <select class="form-control" name="t_type" onchange="this.form.submit()">
                <option selected>Debit Normal</option>
                <option>Debit Abnormal</option>
                <option>Credit Normal</option>
                <option>Credit Abnormal</option>
              </select>
            </div>
          </div>
          <div class="col-3" style="width:150px">
            <div class="form-outline">
              <select class="form-control" name="period" onchange="this.form.submit()">
                <option>1 Month</option>
                <option>3 Months</option>
                <option>6 Months</option>
                <option selected>12 Months</option>
                <option>24 Months</option>
                <option>All</option>
              </select>
            </div>
          </div>

          <div class="col-2" style="width:120px;padding-top:5px">
              <label for="duration" class="form-label">Less Than</label>
          </div>
          <div class="col-3" style="width:150px">
            <div class="form-outline">
              <select class="form-control" name="value_lt" onchange="this.form.submit()">
                <option selected></option>
                <option>100</option>
                <option>200</option>
                <option>400</option>
                <option>500</option>
                <option>600</option>
                <option>800</option>
                <option>1000</option>
                <option>1500</option>
                <option>3000</option>
              </select>
            </div>
          </div>
          <div class="col-2" style="width:120px;padding-top:5px;">
            <label for="duration" class="form-label">Greater Than</label>
          </div>
          <div class="col-2" style="width:150px">
            <div class="form-outline">
              <select class="form-control" name="value_gt" onchange="this.form.submit()">
                <option selected></option>
                <option>100</option>
                <option>200</option>
                <option>400</option>
                <option>500</option>
                <option>600</option>
                <option>800</option>
                <option>1000</option>
                <option>1500</option>
                <option>3000</option>
              </select>
            </div>
          </div>
        
          <!-- <div class="col-3">
             <button type="submit" class="btn btn-primary" name="action" value="refresh">Refresh</button>
          </div> -->
        </div>
        </fieldset>
        </form>
    <!-- </div>
  </div>
</div> -->

<!-- <form method="get" _lpchecked="1" id="myform">
<fieldset>
<div class="form-group row">
  <div class="col-3" style="width:150px">
    <div class="form-outline">
      <select class="form-control" name="period" onchange="this.form.submit()">
        <option>1 Month</option>
        <option>3 Months</option>
        <option>6 Months</option>
        <option selected>12 Months</option>
        <option>24 Months</option>
        <option>All</option>
      </select>
    </div>
  </div>
</div>
</fieldset>
</form> -->


<div class="row mt-2">
  <div class="col-12">
    <div class="card {{ CARD_CLASS }} mb-2">
      <div class="card-header d-flex align-items-center">
        <div class="flex-grow-1">Transactions</div>
        <div class="d-flex align-items-center" style="gap:8px;">
          <div class="small">Search:</div>
          <input id="descriptionSearchInput" type="text" class="form-control form-control-sm" style="width:320px;" placeholder="Description contains..." />
          <button type="button" class="btn btn-outline-secondary btn-sm" id="transactionCopyBtn" onclick="copyTransactionsToClipboard()">Copy</button>
        </div>
      </div>
      <div class="card-body">
        <div id="transaction_grid" class="ag-grid-host" style="width:100%;height:260px;"></div>
        <script type="application/json" id="initialTransactionsJson">
[
{% for t in transactions %}
  [
    {{ t[0] | tojson }},
    {{ (t[1] | string) | tojson }},
    {{ (t[2] | default('') | string) | tojson }},
    {{ (t[3] | float) | tojson }},
    {{ (t[4] | default('') | string) | tojson }},
    {{ (t[5] | default('') | string) | tojson }},
    {{ (t[6] | default('') | string) | tojson }},
    {{ (t[7] | default('') | string) | tojson }}
  ]{{ "," if not loop.last else "" }}
{% endfor %}
]
        </script>
      </div>
    </div>
  </div>
</div>

{% endblock %}